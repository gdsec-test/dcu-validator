BUILDNAME=digital-crimes/dcu-validator-scheduler
BUILDROOT=$(HOME)/dockerbuild/$(BUILDNAME)
SHELL=/bin/bash

.PHONY: prep build

all: env

env:
	pip install -r test_requirements.txt
	pip install -r requirements.txt

.PHONY: flake8
flake8:
	@echo "----- Running linter -----"
	flake8 --config ./.flake8 .

.PHONY: isort
isort:
	@echo "----- Optimizing imports -----"
	isort --atomic --skip scheduler_service/grpc_stub --skip .venv/ .

.PHONY: tools
tools: flake8 isort

.PHONY: test
test: tools
	@echo "----- Running tests -----"
	nosetests tests

.PHONY: testcov
testcov:
	@echo "----- Running tests with coverage -----"
	nosetests tests --with-coverage --cover-erase --cover-package=scheduler_service --cover-xml

prep:
	@echo "----- preparing $(IMAGE) build -----"
	mkdir -p $(BUILDROOT)
	cp -rp ./* $(BUILDROOT)
	cp -rp ~/.pip $(BUILDROOT)/pip_config

build: prep
	@echo "----- building $(IMAGE):$(TAG) -----"
	docker build -t $(IMAGE):$(TAG) $(BUILDROOT)

clean:
	@echo "----- cleaning $(BUILDROOT) -----"
	rm -rf $(BUILDROOT)
	
